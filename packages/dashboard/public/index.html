<!doctype html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            fontFamily: {
              sans: [
                "Inter",
                "system-ui",
                "-apple-system",
                "Segoe UI",
                "sans-serif",
                "Apple Color Emoji",
                "Segoe UI Emoji",
              ],
            },
            colors: {
              tokyo: {
                bg: "#1a1b26",
                panel: "#1f2335",
                card: "#24283b",
                text: "#c0caf5",
                muted: "#565f89",
                gray: "#6b7280",
                blue: "#7aa2f7",
                purple: "#bb9af7",
                green: "#9ece6a",
                red: "#f7768e",
                orange: "#ff9e64",
                cyan: "#7dcfff",
              },
            },
          },
        },
      };
    </script>

    <!-- Load agent info -->
    <script>
      fetch("/api/hatching/status")
        .then((r) => r.json())
        .then((data) => {
          if (data.hatched && data.agentName) {
            document.title = data.agentName + " — Dashboard";
            window.__agentName = data.agentName;
          }
        })
        .catch(() => {});
    </script>

    <!-- Alpine.js -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Markdown + sanitization -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js"></script>

    <!-- App styles -->
    <link rel="stylesheet" href="css/app.css" />
  </head>

  <body class="bg-tokyo-bg text-tokyo-text antialiased">
    <!-- ================================================================== -->
    <!-- Main app shell — full viewport, no body scroll                     -->
    <!-- ================================================================== -->
    <div x-data="chat()" class="flex h-screen w-full">
      <!-- ============================================================== -->
      <!-- Sidebar                                                        -->
      <!-- ============================================================== -->
      <aside
        class="sidebar-panel shrink-0 border-r border-tokyo-muted/10 bg-tokyo-panel overflow-y-auto transition-all duration-300"
        :class="sidebarOpen ? 'sidebar-open' : 'sidebar-closed'"
      >
        <div class="p-3 flex flex-col h-full">
          <!-- New conversation button -->
          <button
            @click="createNewConversation()"
            class="w-full flex items-center justify-center gap-2 px-3 py-2 rounded-lg bg-tokyo-blue/10 text-tokyo-blue hover:bg-tokyo-blue/20 transition-colors text-sm font-medium mb-3"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              class="w-4 h-4"
            >
              <path
                d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z"
              />
            </svg>
            <span>New Chat</span>
          </button>

          <!-- Conversation list -->
          <div class="flex-1 overflow-y-auto space-y-1">
            <template x-for="conv in conversations" :key="conv.id">
              <button
                @click="switchConversation(conv.id)"
                class="w-full text-left px-3 py-2 rounded-lg transition-colors"
                :class="
                  currentConversationId === conv.id
                    ? 'bg-tokyo-blue/15 text-tokyo-blue'
                    : 'hover:bg-tokyo-card/50 text-tokyo-text'
                "
              >
                <div class="flex flex-col gap-1">
                  <div
                    class="text-sm font-medium truncate"
                    x-text="conv.title || 'New conversation'"
                  ></div>
                  <div
                    class="text-xs text-tokyo-muted"
                    x-text="formatRelativeTime(conv.updated)"
                  ></div>
                </div>
              </button>
            </template>
          </div>
        </div>
      </aside>

      <!-- Main chat area -->
      <div class="flex flex-col flex-1 min-w-0 max-w-3xl mx-auto w-full">
        <!-- ============================================================== -->
        <!-- Header                                                         -->
        <!-- ============================================================== -->
        <header
          class="flex items-center gap-3 px-4 h-12 shrink-0"
          style="
            background: #1a1b26;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
          "
        >
          <!-- Sidebar toggle button -->
          <button
            @click="sidebarOpen = !sidebarOpen"
            class="w-7 h-7 flex items-center justify-center rounded-lg hover:bg-tokyo-card transition-colors shrink-0"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 20 20"
              fill="currentColor"
              class="w-5 h-5"
            >
              <path
                fill-rule="evenodd"
                d="M2 4.75A.75.75 0 0 1 2.75 4h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 4.75ZM2 10a.75.75 0 0 1 .75-.75h14.5a.75.75 0 0 1 0 1.5H2.75A.75.75 0 0 1 2 10Zm0 5.25a.75.75 0 0 1 .75-.75h14.5a.75.75 0 0 1 0 1.5H2.75a.75.75 0 0 1-.75-.75Z"
                clip-rule="evenodd"
              />
            </svg>
          </button>
          <!-- Agent avatar (small) -->
          <div
            class="w-7 h-7 rounded-full flex items-center justify-center shrink-0 text-xs font-semibold text-white"
            style="background: linear-gradient(135deg, #a855f7, #ec4899)"
            x-text="headerInitial"
          >
            A
          </div>

          <!-- Name + status -->
          <div class="flex flex-col leading-tight">
            <span
              class="text-sm font-semibold"
              style="
                background: linear-gradient(135deg, #a855f7, #ec4899);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
                background-clip: text;
              "
              x-text="headerName"
              >My Agent</span
            >
            <span class="flex items-center gap-1" style="font-size: 11px">
              <span
                class="inline-block w-1.5 h-1.5 rounded-full bg-tokyo-green"
              ></span>
              <span class="text-tokyo-muted">Online</span>
            </span>
          </div>

          <!-- Conversation title (editable) -->
          <div class="flex-1 min-w-0 ml-3">
            <!-- Display mode -->
            <div
              x-show="!editingTitle"
              @click="startTitleEdit()"
              class="conversation-title-display text-sm text-tokyo-muted cursor-pointer hover:text-tokyo-text transition-colors truncate"
              x-text="currentTitle || 'New conversation'"
            ></div>

            <!-- Edit mode -->
            <input
              x-show="editingTitle"
              x-ref="titleInput"
              x-model="editTitleValue"
              type="text"
              class="conversation-title-input text-sm text-tokyo-text bg-transparent border-none outline-none w-full"
              placeholder="Conversation title"
              @keydown.enter="confirmTitleEdit()"
              @keydown.escape="cancelTitleEdit()"
              @blur="cancelTitleEdit()"
            />
          </div>
        </header>

        <!-- ============================================================== -->
        <!-- Messages area                                                  -->
        <!-- ============================================================== -->
        <main
          x-ref="messagesContainer"
          class="flex-1 overflow-y-auto overflow-x-hidden p-4 space-y-4"
        >
          <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
          <!-- Welcome state (no messages)                              -->
          <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
          <template x-if="messages.length === 0">
            <div
              class="flex flex-col items-center justify-center h-full select-none"
              x-cloak
            >
              <!-- Avatar -->
              <div
                class="w-12 h-12 rounded-full flex items-center justify-center text-lg font-semibold text-white mb-4"
                style="background: linear-gradient(135deg, #a855f7, #ec4899)"
                x-text="headerInitial"
              >
                A
              </div>

              <!-- Greeting -->
              <h1
                class="text-lg font-semibold mb-1"
                style="
                  background: linear-gradient(135deg, #a855f7, #ec4899);
                  -webkit-background-clip: text;
                  -webkit-text-fill-color: transparent;
                  background-clip: text;
                "
              >
                <span x-text="greetingText">Hey! I'm your agent.</span>
              </h1>
              <p class="text-sm text-gray-400">How can I help you today?</p>
            </div>
          </template>

          <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
          <!-- Message list                                             -->
          <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
          <template x-for="msg in messages" :key="msg.id">
            <div class="msg-enter">
              <!-- ── Assistant message ────────────────────────────── -->
              <template x-if="msg.role === 'assistant'">
                <div class="flex items-start gap-2.5 max-w-[85%]">
                  <!-- Avatar -->
                  <div
                    class="w-7 h-7 rounded-full flex items-center justify-center shrink-0 text-xs font-semibold text-white mt-0.5"
                    style="
                      background: linear-gradient(135deg, #a855f7, #ec4899);
                    "
                    x-text="headerInitial"
                  >
                    A
                  </div>

                  <!-- Bubble -->
                  <div
                    class="rounded-xl rounded-tl-none px-3 py-2"
                    style="background: rgba(255, 255, 255, 0.05)"
                  >
                    <div
                      class="chat-md text-sm leading-relaxed"
                      x-html="msg.renderedContent"
                    ></div>

                    <!-- Controls (if any) -->
                    <template x-if="msg.controlsHtml">
                      <div x-html="msg.controlsHtml" class="mt-2"></div>
                    </template>

                    <!-- Thinking block (if message has thinking) -->
                    <template x-if="msg.thinkingText">
                      <div class="thinking-block mt-1.5 mb-1">
                        <button
                          @click="msg.thinkingExpanded = !msg.thinkingExpanded"
                          class="flex items-center gap-1.5 text-xs text-tokyo-muted hover:text-tokyo-text transition-colors"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            viewBox="0 0 16 16"
                            fill="currentColor"
                            class="w-3 h-3 transition-transform"
                            :class="msg.thinkingExpanded ? 'rotate-90' : ''"
                          >
                            <path
                              d="M6.22 4.22a.75.75 0 0 1 1.06 0l3.25 3.25a.75.75 0 0 1 0 1.06l-3.25 3.25a.75.75 0 0 1-1.06-1.06L8.94 8 6.22 5.28a.75.75 0 0 1 0-1.06Z"
                            />
                          </svg>
                          <span
                            x-text="msg.thinkingExpanded ? 'Hide thinking' : 'Show thinking'"
                          ></span>
                        </button>
                        <div x-show="msg.thinkingExpanded" x-collapse>
                          <pre
                            class="thinking-content mt-1 text-xs leading-relaxed text-tokyo-muted whitespace-pre-wrap"
                            x-text="msg.thinkingText"
                          ></pre>
                        </div>
                      </div>
                    </template>

                    <div
                      class="text-tokyo-muted mt-1 text-right"
                      style="font-size: 11px"
                      x-text="msg.timestamp"
                    ></div>
                  </div>
                </div>
              </template>

              <!-- ── User message ─────────────────────────────────── -->
              <template x-if="msg.role === 'user'">
                <div class="flex justify-end">
                  <div
                    class="max-w-[85%] rounded-xl rounded-tr-none px-3 py-2"
                    style="background: rgba(122, 162, 247, 0.1)"
                  >
                    <div
                      class="chat-md text-sm leading-relaxed"
                      x-html="msg.renderedContent"
                    ></div>
                    <div
                      class="text-tokyo-muted mt-1 text-right"
                      style="font-size: 11px"
                      x-text="msg.timestamp"
                    ></div>
                  </div>
                </div>
              </template>
            </div>
          </template>

          <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
          <!-- Typing indicator                                         -->
          <!-- ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ -->
          <div
            x-show="isResponding && !currentAssistantMessage"
            x-cloak
            class="msg-enter"
          >
            <div class="flex items-start gap-2.5">
              <!-- Avatar -->
              <div
                class="w-7 h-7 rounded-full flex items-center justify-center shrink-0 text-xs font-semibold text-white mt-0.5"
                style="background: linear-gradient(135deg, #a855f7, #ec4899)"
                x-text="headerInitial"
              >
                A
              </div>

              <!-- Dots bubble -->
              <div
                class="rounded-xl rounded-tl-none px-4 py-3"
                style="background: rgba(255, 255, 255, 0.05)"
              >
                <template x-if="isThinking">
                  <span class="text-xs text-tokyo-purple">Thinking...</span>
                </template>
                <template x-if="!isThinking">
                  <div class="typing-dots flex items-center gap-1">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </main>

        <!-- ============================================================== -->
        <!-- Compose area                                                   -->
        <!-- ============================================================== -->
        <footer
          class="shrink-0 p-3"
          style="border-top: 1px solid rgba(255, 255, 255, 0.06)"
        >
          <div
            class="flex items-end gap-2 rounded-xl px-3 py-2"
            style="
              background: rgba(255, 255, 255, 0.05);
              border: 1px solid rgba(255, 255, 255, 0.06);
            "
          >
            <!-- Textarea (normal mode) -->
            <textarea
              x-ref="chatInput"
              x-model="inputText"
              x-show="!composePasswordMode"
              rows="1"
              :placeholder="currentPlaceholder"
              class="flex-1 bg-transparent text-sm text-tokyo-text placeholder-tokyo-muted resize-none outline-none leading-relaxed"
              style="max-height: 7.5rem"
              @keydown.enter="
              if (!$event.shiftKey) {
                $event.preventDefault();
                sendMessage();
              }
            "
              @input="autoResize($refs.chatInput)"
            ></textarea>

            <!-- Password input (shown only in password mode) -->
            <input
              x-ref="chatInputPassword"
              x-model="inputText"
              x-show="composePasswordMode"
              type="password"
              :placeholder="currentPlaceholder"
              class="flex-1 bg-transparent text-sm text-tokyo-text placeholder-tokyo-muted outline-none leading-relaxed"
              @keydown.enter="$event.preventDefault(); sendMessage();"
            />

            <!-- Send button -->
            <button
              x-show="!isResponding"
              @click="sendMessage()"
              :disabled="!canSend"
              class="shrink-0 w-8 h-8 flex items-center justify-center rounded-lg transition-all duration-150"
              :class="
              canSend
                ? 'bg-tokyo-blue/20 text-tokyo-blue hover:bg-tokyo-blue/30 cursor-pointer'
                : 'text-tokyo-muted opacity-30 cursor-default'
            "
            >
              <!-- Send icon (arrow up) -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                class="w-4 h-4"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 17a.75.75 0 0 1-.75-.75V5.612L5.29 9.77a.75.75 0 0 1-1.08-1.04l5.25-5.5a.75.75 0 0 1 1.08 0l5.25 5.5a.75.75 0 1 1-1.08 1.04l-3.96-4.158V16.25A.75.75 0 0 1 10 17Z"
                  clip-rule="evenodd"
                />
              </svg>
            </button>

            <!-- Stop button -->
            <button
              x-show="isResponding"
              @click="stopResponse()"
              class="shrink-0 w-8 h-8 flex items-center justify-center rounded-lg bg-tokyo-red/20 text-tokyo-red hover:bg-tokyo-red/30 cursor-pointer transition-all duration-150"
            >
              <!-- Stop icon (square) -->
              <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 20 20"
                fill="currentColor"
                class="w-3.5 h-3.5"
              >
                <rect x="5" y="5" width="10" height="10" rx="1" />
              </svg>
            </button>
          </div>
        </footer>
      </div>
    </div>

    <!-- App logic (must load before Alpine processes x-data) -->
    <script src="js/ws-client.js"></script>
    <script src="js/chat-controls.js"></script>
    <script src="js/app.js"></script>
  </body>
</html>
